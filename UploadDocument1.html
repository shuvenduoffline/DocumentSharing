<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document Sharing Application</title>
    <script src="./node_modules/web3/dist/web3.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

</head>

<body>
    <div class="container">

    

        <div >
            <h2 class="m-auto" id="headingtxt">Publish Document</h2>
            
                <label for="address">Publish To Address :</label><br>
                <input class="form-control" type="text" id="address" name="address" value="0x14314f22aE42A411e2B25EbA5ddD8796BBfdB534" disabled><br>
                <label for="docid">Document ID :</label><br>
                <input class="form-control" type="text" id="docid" name="docid" hint="Ipfs hash"><br>
                <label for="docname">Document Name :</label><br>
                <input class="form-control" type="text" id="docname" name="docname"><br><br>
                <input  class="btn btn-primary" type="submit" onclick="uploadDocument()" value="Publish Document">

                <button class="btn" onclick="goHome()" >Home</button>
            
          </div>

    </div>


    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>



 


    <script>

        const ethEnabled = () => {
            if (window.ethereum) {
                window.web3 = new Web3(window.ethereum);
                window.ethereum.enable();
                return true;
            }
            return false;
        }

        //show alert when no metamusk is present
        if (!ethEnabled()) {
            alert("Please install an Ethereum-compatible browser or extension like MetaMask to use this dApp!");
        }



        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
            console.log("Metamusk is set");
        } else {
            // set the provider you want from Web3.providers
            web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }


        web3.eth.net.isListening()
         .then(() => console.log('web3 is connected'))
         .catch(e => console.log('Wow. Something went wrong with the web3'));

    const abi=[{
                "inputs": [{
                    "internalType": "address",
                    "name": "corporationContractAddress",
                    "type": "address"
                }],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [{
                        "indexed": false,
                        "internalType": "address",
                        "name": "corporationAddress",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "bool",
                        "name": "successFlag",
                        "type": "bool"
                    }
                ],
                "name": "documentManagementEvent",
                "type": "event"
            },
            {
                "stateMutability": "nonpayable",
                "type": "fallback"
            },
            {
                "inputs": [{
                        "internalType": "uint256",
                        "name": "from",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "numberOfRecords",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "corporationContractAddress",
                        "type": "address"
                    }
                ],
                "name": "getDocumentIds",
                "outputs": [{
                    "internalType": "bytes",
                    "name": "returnMap",
                    "type": "bytes"
                }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{
                        "internalType": "uint256",
                        "name": "from",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "numberOfRecords",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "corporationContractAddress",
                        "type": "address"
                    }
                ],
                "name": "getDocumentNames",
                "outputs": [{
                    "internalType": "bytes",
                    "name": "returnMap",
                    "type": "bytes"
                }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{
                        "internalType": "uint256",
                        "name": "from",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "corporationContractAddress",
                        "type": "address"
                    }
                ],
                "name": "getDocumentPublishedDates",
                "outputs": [{
                    "internalType": "bytes32[5]",
                    "name": "returnMap",
                    "type": "bytes32[5]"
                }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{
                        "internalType": "uint256",
                        "name": "from",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "corporationContractAddress",
                        "type": "address"
                    }
                ],
                "name": "getDocumentPublishers",
                "outputs": [{
                    "internalType": "address[5]",
                    "name": "returnMap",
                    "type": "address[5]"
                }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{
                        "internalType": "address",
                        "name": "corporationContractAddress",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "from",
                        "type": "uint256"
                    }
                ],
                "name": "getDocumentSharingMethods",
                "outputs": [{
                    "internalType": "bytes32[7]",
                    "name": "returnMap",
                    "type": "bytes32[7]"
                }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{
                        "internalType": "address",
                        "name": "assignedToAddress",
                        "type": "address"
                    },
                    {
                        "internalType": "bytes",
                        "name": "documentId",
                        "type": "bytes"
                    },
                    {
                        "internalType": "bytes",
                        "name": "documentName",
                        "type": "bytes"
                    },
                    {
                        "internalType": "bytes32",
                        "name": "publishedDate",
                        "type": "bytes32"
                    },
                    {
                        "internalType": "address",
                        "name": "corporationContractAddress",
                        "type": "address"
                    }
                ],
                "name": "publishDocument",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];
    const contract_Address="0x43853177d4Aa049eEB42C622fCCf393c36ac0Feb";
    const contract = new web3.eth.Contract(abi, contract_Address);
    const corporationContractAddress = "0x12b8d48aedF226Da28d8c27abB6eeC6b3eEcCEf9";
    var account_address;

 //   contract.defaultAccount = defaultAddress;

 
        web3.eth.getAccounts()
        .then(result => {
            console.log(result);
            web3.eth.defaultAccount = result[0];
            contract.defaultAccount = result[0];
            account_address = result[0];
        })
        .catch(error=>{
            console.log("Something went wrong on getting account address.")
        })


//     async function rpc(func) {
//     while (true) {
//         try {
//             return await func.call();
//         }
//         catch (error) {
//             if (!error.message.startsWith("Invalid JSON RPC response"))
//                 throw error;
//         }
//     }
// }

    

    function getDocumentID(){
        console.log("Getting doc ids ...")
        const to_count = 0;
        const from_count = 5;
        contract.methods.getDocumentIds(to_count,from_count,corporationContractAddress)
        .call()
        .then(result => console.log(result))
        .catch(error => console.log(error));
    }

    function getDocumentNames(){
        console.log("Getting doc names ...")
        const to_count = 0;
        const from_count = 5;
        contract.methods.getDocumentNames(to_count,from_count,corporationContractAddress)
        .call()
        .then(result => {
            console.log(result);
            var return_str = web3.utils.toAscii(result);
            var names = return_str.split(",");
            names.forEach(str => {
                console.log("Res :",str);
                var n = str.indexOf("�");
                console.log("N ",n);
                console.log("RR : ",str.substr(0,n));
            });
        })
        .catch(error => console.log(error));
    }

    function getDocumentPublishedDates(){
        console.log("Getting doc publish dates ...")
        const to_count = 0;
        const from_count = 5;
        contract.methods.getDocumentPublishedDates(to_count,corporationContractAddress)
        .call()
        .then(result => console.log(result))
        .catch(error => console.log(error));
    }


    function getDocumentPublishers(){
        console.log("Getting doc publishers ...")
        const from_count = 0;
        contract.methods.getDocumentPublishers(from_count,corporationContractAddress)
        .call()
        .then(result => console.log(result))
        .catch(error => console.log(error));
    }

    function publishDocument(){
        console.log("Publishing dummy document ...")
        const ipfsHash = "QmZULkCELmmk5XNfCgTnCyFgAVxBRBXyDHGGMVoLFLiXEN", //ipfs hash
            docName = "MyAadharHello",   //web3.utils.fromAscii(docName)
            publishDate = new Date().toLocaleDateString();

        contract.methods
        .publishDocument(
            "0x14314f22aE42A411e2B25EbA5ddD8796BBfdB534",  //assign to
        "0x001d3f1ef827552ae1114027bd3ecf1f086ba0f9",   //doc id
        "0xd9145CCE52D386f254917e481eB44e9943F39138",  //doc name
        "0x32322f30372f3230323000000000000000000000000000000000000000000000",  //date
        "0x12b8d48aedF226Da28d8c27abB6eeC6b3eEcCEf9")     //corporationContractAddress
        .send({
            "from": "0x14314f22ae42a411e2b25eba5ddd8796bbfdb534",
            "gas": "500000",
            "gasPrice": "5000000000",
            "value": "0"
            })
        .then(result => console.log(result))
        .catch(error => console.log(error));
    }

   

    function uploadDocument(){
        

        const docID = document.getElementById("docid").value;
        const docName = document.getElementById("docname").value;
        const publishTo = document.getElementById("address").value;

        if(docID === undefined || docID === "" 
        || docName === "" || docName === undefined 
        || account_address === undefined || account_address === ""){
            alert("Provide Valid Input");
            return;
        }
                
        document.getElementById("headingtxt").innerHTML = "Publishing Document ..";

        console.log("Uploading document ..");
        console.log("doc id",docID);
        console.log("doc nm",docName);
        console.log("Publish to",publishTo);

        console.log("Publishing dummy document ...")
        var publishDate = new Date().toLocaleDateString(); //web3.utils.fromAscii(docName)


            //convert to better use
            publishDate = web3.utils.fromAscii(publishDate);
            const name = web3.utils.fromAscii(docName);
            const doc_id = web3.utils.fromAscii(docID);

        contract.methods
        .publishDocument(
            "0x14314f22aE42A411e2B25EbA5ddD8796BBfdB534",  //assign to
        doc_id,   //doc id
        name,  //doc name
        publishDate,  //date
        "0x12b8d48aedF226Da28d8c27abB6eeC6b3eEcCEf9")     //corporationContractAddress
        .send({
            "from": account_address,
            "gas": "500000",
            "gasPrice": "5000000000",
            "value": "0"
            })
        .then(result => {
            console.log(result);
            document.getElementById("headingtxt").innerHTML = "Document Published ..";
            location.replace("Corporation1.html");;
        })
        .catch(error => console.log(error));

        
    }



    
    function goHome(){
            // location.replace("Corporation1.html")
            window.history.back();
        }


    </script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

</body>

</html>